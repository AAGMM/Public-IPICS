jobs:
- job: SetupAndRun
  displayName: 'E2E Tests'
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UseDotNet@2
    displayName: 'Use .Net Core sdk'
    inputs:
      useGlobalJson: true

  - task: AzureCLI@2
    displayName: 'Set Secret Variables'
    inputs:
      azureSubscription: '$(azureSubscriptionName)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        for name in $(az keyvault secret list --vault-name "$(deploymentName)-ts" | jq '.[] | .name')
        do
            envVar=$(sed "s/--/__/g" <<< $name)
            value=$(az keyvault secret show --name $name --vault-name "$(deploymentName)-ts" | jq '.value')
            echo "##vso[task.setvariable variable=$envVar]$value"
        done
      failOnStandardError: true

  - bash: |
      echo "##vso[task.setvariable variable=Resource]$(testEnvironmentUrl)"
      echo "##vso[task.setvariable variable=security_scope]$(testApplicationScope)"
      echo "##vso[task.setvariable variable=security_resource]$(testApplicationResource)"
      echo "##vso[task.setvariable variable=security_enabled]$true"

      dotnet dev-certs https
    displayName: 'Setup Authentication'

  - template: ../common/run-e2e-tests.yml
