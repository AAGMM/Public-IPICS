steps:
- task: UseDotNet@2
  displayName: 'Use .NET Core 5.x'
  inputs:
    packageType: sdk
    version: 5.x

- task: PowerShell@2
  name: 'GitVersion'
  displayName: 'Run GitVersion'
  inputs:
    targetType: 'inline'
    script: |
      # Derive version using the tool GitVersion
      dotnet new tool-manifest
      dotnet tool install GitVersion.Tool --version 5.6.6 --configfile nuget.config
      $GitVersion = dotnet tool run dotnet-gitversion /config GitVersion.yml /output json /nofetch | ConvertFrom-Json

      # Print
      $GitVersion

      # Create variables
      $semVer = $GitVersion.semVer
      $informationalVersion = $GitVersion.informationalVersion
      $majorMinorPatch = $GitVersion.majorMinorPatch
      $assemblySemVer = $GitVersion.assemblySemVer
      $assemblySemFileVer = $GitVersion.assemblySemFileVer

      # Define output variables
      Write-Host "##vso[task.setvariable variable=semVer;isOutput=true]$semVer"
      Write-Host "##vso[task.setvariable variable=informationalVersion;isOutput=true]$informationalVersion"
      Write-Host "##vso[task.setvariable variable=majorMinorPatch;isOutput=true]$majorMinorPatch"
      Write-Host "##vso[task.setvariable variable=nuGetVersion;isOutput=true]$semVer"
      Write-Host "##vso[task.setvariable variable=assemblySemVer;isOutput=true]$assemblySemVer"
      Write-Host "##vso[task.setvariable variable=assemblySemFileVer;isOutput=true]$assemblySemFileVer"
    failOnStderr: true
    showWarnings: true
    pwsh: true
    workingDirectory: '$(Build.SourcesDirectory)'

- powershell: |
    Write-Host '----------Variables to use for build----------'
    Write-Host 'semVer: $(semVer)'
    Write-Host 'informationalVersion: $(informationalVersion)'
    Write-Host 'majorMinorPatch: $(majorMinorPatch)'
    Write-Host 'assemblySemVer: $(assemblySemVer)'
    Write-Host 'assemblySemFileVer: $(assemblySemFileVer)'
    Write-Host 'nuGetVersion: $(nuGetVersion)'
  name: PrintVariablesFromGitVersion
