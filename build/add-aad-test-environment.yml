steps:

- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: resolute-oss-tenant-info'
  inputs:
    azureSubscription: $(azureSubscriptionName)
    KeyVaultName: 'resolute-oss-tenant-info'

- task: AzurePowerShell@4
  displayName: Setup Aad Test Tenant
  inputs:
    azureSubscription: $(azureSubscriptionName)
    azurePowerShellVersion: latestVersion
    ScriptType: inlineScript
    Inline: |
      Install-Module -Name AzureAD -Force -Verbose -Scope CurrentUser
      $tenantId = "$(tenant-id)"

      # Get admin token
      $username = "$(tenant-admin-user-name)"
      $password_raw = "$(tenant-admin-user-password)"
      $password =  ConvertTo-SecureString -AsPlainText $password_raw -Force
      $adminCredential = New-Object PSCredential $username,$password

      $adTokenUrl = "https://login.microsoftonline.com/$tenantId/oauth2/token"
      $resource = "https://graph.windows.net/"

      $body = @{
          grant_type = "password"
          username   = $username
          password   = $password_raw
          resource   = $resource 
          client_id  = "1950a258-227b-4e31-a9cf-717495945fc2" # Microsoft Azure PowerShell
      }
              
      # If a deleted keyvault exists, remove it
      if (Get-AzKeyVault -VaultName "$(deploymentName)-ts" -Location "$(resourceGroupRegion)" -InRemovedState)
      {
          Write-Host "'$(deploymentName)-ts' found in '$(resourceGroupRegion)'. Attempting to remove."
          Remove-AzKeyVault -VaultName "$(deploymentName)-ts" -InRemovedState -Location "$(resourceGroupRegion)" -Force
      }
      else
      {
          Write-Host "'$(deploymentName)-ts' not found in '$(resourceGroupRegion)'"
      }

      $response = Invoke-RestMethod -Method 'Post' -Uri $adTokenUrl -ContentType "application/x-www-form-urlencoded" -Body $body
      Connect-AzureAD -TenantId $tenantId -AadAccessToken $response.access_token -AccountId $username

      Import-Module $(System.DefaultWorkingDirectory)/samples/scripts/PowerShell/DicomServer.psd1
      Import-Module $(System.DefaultWorkingDirectory)/release/scripts/PowerShell/DicomServerRelease/DicomServerRelease.psd1

      $output = Add-AadTestAuthEnvironment -TestAuthEnvironmentPath $(System.DefaultWorkingDirectory)/testauthenvironment.json -EnvironmentName $(deploymentName) -TenantAdminCredential $adminCredential -EnvironmentLocation $(resourceGroupRegion)

- task: AzurePowerShell@4
    displayName: 'Set Variables for Admin Consent'
    inputs:
      azureSubscription: $(azureSubscriptionName)
      azurePowerShellVersion: latestVersion
      ScriptType: inlineScript
      Inline: |
        $vaultName = $(deploymentName)-ts       

        [string]$appId = Get-AzKeyVaultSecret -VaultName $vaultName -Name "app_id" -AsPlainText -ErrorAction SilentlyContinue
        Write-Host "##vso[task.setvariable variable=appid]$($appId)"

        [string[]]$clientAppIds = @()
        $secrets = Get-AzKeyVaultSecret -VaultName $vaultName
        foreach($secret in $secrets)
        {
            if($secret.Name.StartsWith("app--") -and $secret.Name.EndsWith("--id"))
            {
              [string]$id = Get-AzKeyVaultSecret -VaultName $vaultName -Name $secret.Name -AsPlainText
              $clientAppIds += $id
            }   
        }

        $clientAppIdsText =  $clientAppIds -join ","
        Write-Host "##vso[task.setvariable variable=clientappids]$($clientAppIdsText)"

- task: AzureCLI@2
  displayName: Grant Admin Consent
  inputs:
    azureSubscription: $(azureSubscriptionName)
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      $username = "$(tenant-admin-user-name)"      
      $password = "$(tenant-admin-user-password)"
      $tenantId = "$(tenant-id)"
      az login --username "$username"  --password  "$password"  --tenant "$tenantId" --allow-no-subscriptions
      $appId = "$(appid)"
      $clientAppIds = "$(clientappids)" -split ","
      foreach($clientAppId in $clientAppIds)
      {
          az ad app permission grant --id $clientAppId --api 00000002-0000-0000-c000-000000000000 --scope "User.Read"
          az ad app permission grant --id $clientAppId --api $appId --scope "user_impersonation"
      }