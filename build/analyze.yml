parameters:
  advanced: false

steps:
- task: CodeInspector@2
  condition: eq('${{ parameters.advanced }}', 'true')
  inputs:
    ExcludeFilters: 'samples,test,docs,build,.vs,.git,.github,.gdn'

- task: AntiMalware@4
  inputs:
    InputType: 'Basic'
    ScanType: 'CustomScan'
    FileDirPath: '$(Build.SourcesDirectory)'
    EnableServices: true
    TreatSignatureUpdateFailureAs: 'Standard'
    SignatureFreshness: 'OneDay'
    TreatStaleSignatureAs: 'Error'

- task: Armory@2
  inputs:
    targetDirectory: '$(Build.SourcesDirectory)\samples\templates'
    targetFiles: 'f|*.json'
    excludePassesFromLog: false

- task: BinSkim@4
  inputs:
    InputType: 'Basic'
    Function: 'analyze'
    AnalyzeTargetGlob: '+:file|$(Build.SourcesDirectory)\**\bin\**\Microsoft.Health.Dicom*.dll;+:file|$(Build.SourcesDirectory)\**\bin\**\Microsoft.Health.Dicom*.exe'
    AnalyzeVerbose: true

- task: CredScan@3
  inputs:
    scanFolder: '$(Build.SourcesDirectory)'
    outputFormat: 'sarif'
    suppressionsFile: 'CredScanSuppressions.json'
    verboseOutput: true

- task: Semmle@1
  condition: eq('${{ parameters.advanced }}', 'true')
  inputs:
    sourceCodeDirectory: '$(Build.SourcesDirectory)'
    language: 'csharp'
    querySuite: 'Recommended'
    buildCommands: |
      \\\\\\\"C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe\\\\\\\" $(BUILD.SourcesDirectory)\Microsoft.Health.Dicom.sln -t:Build -p:Configuration=$(BuildConfiguration) -p:ContinuousIntegrationBuild=true
      \\\\\\\"C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe\\\\\\\" $(BUILD.SourcesDirectory)\converter\dicom-cast\Microsoft.Health.DicomCast.sln -t:Build -p:Configuration=$(BuildConfiguration) -p:ContinuousIntegrationBuild=true
    timeout: '1800'
    ram: '16384'
    addProjectDirToScanningExclusionList: true

- task: SdtReport@2
  inputs:
    GdnExportAllTools: false
    GdnExportGdnToolArmory: true
    GdnExportGdnToolBinSkim: true
    GdnExportGdnToolCredScan: true
    GdnExportGdnToolSemmle: ${{ parameters.advanced }}

- task: PublishSecurityAnalysisLogs@3
  inputs:
    ArtifactName: 'CodeAnalysisLogs'
    ArtifactType: 'Container'
    AllTools: false
    AntiMalware: true
    APIScan: false
    Armory: true
    Bandit: false
    BinSkim: true
    CodesignValidation: false
    CredScan: true
    CSRF: false
    ESLint: false
    Flawfinder: false
    FortifySCA: false
    FxCop: false
    ModernCop: false
    MSRD: false
    PoliCheck: false
    RoslynAnalyzers: false
    SDLNativeRules: false
    Semmle: ${{ parameters.advanced }}
    SpotBugs: false
    TSLint: false
    WebScout: false
    ToolLogsNotFoundAction: 'Error'

- task: PostAnalysis@2
  inputs:
    GdnBreakAllTools: false
    GdnBreakGdnToolArmory: true
    GdnBreakGdnToolBinSkim: true
    GdnBreakGdnToolCredScan: true
    GdnBreakGdnToolSemmle: ${{ parameters.advanced }}
